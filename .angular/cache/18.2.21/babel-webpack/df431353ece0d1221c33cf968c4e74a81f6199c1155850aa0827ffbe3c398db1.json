{"ast":null,"code":"import { inject, NgZone, computed, signal, effect, untracked, VERSION } from \"@angular/core\";\nimport { QueryClient, notifyManager, shouldThrowError } from \"@tanstack/query-core\";\nimport { signalProxy } from \"./signal-proxy.mjs\";\nimport { injectIsRestoring } from \"./inject-is-restoring.mjs\";\nimport { PENDING_TASKS } from \"./pending-tasks-compat.mjs\";\nfunction createBaseQuery(optionsFn, Observer) {\n  const ngZone = inject(NgZone);\n  const pendingTasks = inject(PENDING_TASKS);\n  const queryClient = inject(QueryClient);\n  const isRestoring = injectIsRestoring();\n  const defaultedOptionsSignal = computed(() => {\n    const defaultedOptions = queryClient.defaultQueryOptions(optionsFn());\n    defaultedOptions._optimisticResults = isRestoring() ? \"isRestoring\" : \"optimistic\";\n    return defaultedOptions;\n  });\n  const observerSignal = (() => {\n    let instance = null;\n    return computed(() => {\n      return instance || (instance = new Observer(queryClient, defaultedOptionsSignal()));\n    });\n  })();\n  const optimisticResultSignal = computed(() => observerSignal().getOptimisticResult(defaultedOptionsSignal()));\n  const resultFromSubscriberSignal = signal(null);\n  effect(onCleanup => {\n    const observer = observerSignal();\n    const defaultedOptions = defaultedOptionsSignal();\n    untracked(() => {\n      observer.setOptions(defaultedOptions);\n    });\n    onCleanup(() => {\n      ngZone.run(() => resultFromSubscriberSignal.set(null));\n    });\n  }, {\n    // Set allowSignalWrites to support Angular < v19\n    // Set to undefined to avoid warning on newer versions\n    allowSignalWrites: VERSION.major < \"19\" || void 0\n  });\n  effect(onCleanup => {\n    const observer = observerSignal();\n    let pendingTaskRef = null;\n    const unsubscribe = isRestoring() ? () => void 0 : untracked(() => ngZone.runOutsideAngular(() => {\n      return observer.subscribe(notifyManager.batchCalls(state => {\n        ngZone.run(() => {\n          if (state.fetchStatus === \"fetching\" && !pendingTaskRef) {\n            pendingTaskRef = pendingTasks.add();\n          }\n          if (state.fetchStatus === \"idle\" && pendingTaskRef) {\n            pendingTaskRef();\n            pendingTaskRef = null;\n          }\n          if (state.isError && !state.isFetching && shouldThrowError(observer.options.throwOnError, [state.error, observer.getCurrentQuery()])) {\n            ngZone.onError.emit(state.error);\n            throw state.error;\n          }\n          resultFromSubscriberSignal.set(state);\n        });\n      }));\n    }));\n    onCleanup(() => {\n      if (pendingTaskRef) {\n        pendingTaskRef();\n        pendingTaskRef = null;\n      }\n      unsubscribe();\n    });\n  });\n  return signalProxy(computed(() => {\n    const subscriberResult = resultFromSubscriberSignal();\n    const optimisticResult = optimisticResultSignal();\n    const result = subscriberResult ?? optimisticResult;\n    const observer = observerSignal();\n    const originalRefetch = result.refetch;\n    return {\n      ...result,\n      refetch: (...args) => {\n        observer.setOptions(defaultedOptionsSignal());\n        return originalRefetch(...args);\n      }\n    };\n  }));\n}\nexport { createBaseQuery };\n//# sourceMappingURL=create-base-query.mjs.map","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}